name: Mocha_Accounting_suite

on:
  schedule:
    - cron: "30 5 * * *"   # 11:00 AM IST
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-all-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4


    - name: Set timezone to IST
      run: |
        sudo timedatectl set-timezone Asia/Kolkata || true
        echo "TZ=Asia/Kolkata" >> $GITHUB_ENV
        date

    - name: Set up Python 3.13
      uses: actions/setup-python@v4
      with:
        python-version: "3.13"

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Book Demo Tests
      continue-on-error: true
      run: |
        set +e
        export PYTHONPATH=$PYTHONPATH:$(pwd)

        LOG_DIR=daily_website_book_demo_test_logs
        LOG_FILE=$LOG_DIR/website_book_demo_$(date +'%Y-%m-%d').log
        mkdir -p $LOG_DIR

        echo "=== BOOK DEMO TEST STARTED ===" >> $LOG_FILE

        xvfb-run pytest tests/test_website/test_book_demo.py -v --tb=long -rP >> $LOG_FILE 2>&1
        TEST_EXIT_CODE=$?

        echo "=== BOOK DEMO TEST COMPLETED ===" >> $LOG_FILE
        echo "Exit Code: $TEST_EXIT_CODE" >> $LOG_FILE

        tail -10 $LOG_FILE
        exit $TEST_EXIT_CODE

    - name: Commit and Push Test Results
      if: always()
      run: |
        git config user.name "YashPayer2510"
        git config user.email "yash.payer@mochatechnologies.com"

        if git status --porcelain | grep -q "daily_website_book_demo_test_logs/"; then
          git add daily_website_book_demo_test_logs/
          git commit -m "Daily test results - $(date +'%Y-%m-%d %H:%M:%S')"
          git push || true
        fi

    - name: Upload test logs as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: daily_website_book_demo_test_logs/
        retention-days: 30

    - name: Ensure screenshots folder exists
      if: always()
      run: mkdir -p screenshots

    - name: Upload screenshots as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots
        path: screenshots/
        retention-days: 30

    - name: Get current date
      id: date
      run: echo "today=$(date '+%Y-%m-%d')" >> $GITHUB_OUTPUT

    - name: Find latest log
      id: latest_logs
      run: |
        latest=$(ls -t daily_website_book_demo_test_logs/website_book_demo_*.log | head -1)
        echo "latest_log=$latest" >> $GITHUB_OUTPUT

    - name: Send test log via email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USER }}
        password: ${{ secrets.EMAIL_PASS }}
        subject: "Daily website book demo Logs - ${{ steps.date.outputs.today }}"
        to: yash.payer@mochatechnologies.com, ankit.mourya@mochatechnologies.com, hitesh.aparadh@mochatechnologies.com, abhishek.rai@mochatechnologies.com, ranjeet.gupta@mochatechnologies.com
        from: "Mocha Automation <${{ secrets.EMAIL_USER }}>"
        body: |
          Hello Team,

          Attached is the daily website book demo test log.

          Regards,
          Mocha Automation
        attachments: |
          ${{ steps.latest_logs.outputs.latest_log }}
